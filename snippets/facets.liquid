{% comment %}
    Renders facets (filtering and sorting)
    Accepts:
    - results: {Object} Collection or Search object
    - enable_filtering: {Boolean} Show filtering when true
    - enable_sorting: {Boolean} Show sorting when true
    - collapse_on_larger_devices: {Boolean} Collapse filtering/sorting into menu on larger devices when true
    Usage:
    {% render 'facets', results: collection, enable_filtering: true, enable_sorting: true, collapse_on_larger_devices: false %}
{% endcomment %}

{%- liquid
  assign sort_by = results.sort_by | default: results.default_sort_by
  assign total_active_values = 0
  if results.url
    assign results_url = results.url
  else 
    assign terms = results.terms | escape
    assign results_url = '?q=' | append: terms | append: '&options%5Bprefix%5D=last&sort_by=' | append: sort_by
  endif
-%}
<div class="row m-auto">
    <div class="facets-container col-12">
      <a href="javascript:void(0);" class="close-filter d-lg-none d-block">{% render 'icon-close' %}</a>

        {% assign tag_limit = 5 | times: 1 %}

        {% if collection.all_tags.size > 0 %}
          {% capture cat_array %}{%- render 'advanced-tag-loop' -%}{% endcapture %}
          {% assign cat_array = cat_array | split: '|' %}
          <div class="productgrid--sidebar-section" data-productgrid-filters-content>
            {% comment %}
            <h2 class="productgrid--sidebar-title">
              {{ 'product_grid.filters.title_count' | t: count: 0 }}
            </h2>
            {% endcomment %}
            <nav
              aria-label="Collection filters"
            >
              {% if current_tags.size > 0 %}
                <div class="productgrid--sidebar-item productgrid--sidebar-filters--current d-md-none d-block">
                  {%- render 'product-grid-tags-active' -%}
                </div>
              {% endif %}

              
                {%
                  render 'product-grid-tag-groups',
                  tag_limit: tag_limit,
                  cat_array: cat_array,
                %}
              

            </nav>
          </div>
        {% endif %}
        <div class="active-facets active-facets-mobile {% unless collapse_on_larger_devices %} d-md-none d-block {% endunless %}">
          {%- for filter in results.filters -%}
            {%- for value in filter.active_values -%}
              <facet-remove>
                <a href="{{ value.url_to_remove }}" class="active-facets__button active-facets__button--light">
                  <span class="active-facets__button-inner button button--tertiary">
                    {{ value.label | escape }}
                    {% render 'icon-close-small' %}
                    <span class="visually-hidden">{{ 'products.facets.clear_filter' | t }}</span>
                  </span>
                </a>
              </facet-remove>
            {%- endfor -%}

            {%- if filter.type == "price_range" -%}
              {%- if filter.min_value.value != nil or filter.max_value.value != nil -%}
                <facet-remove>
                  <a href="{{ filter.url_to_remove }}" class="active-facets__button active-facets__button--light">
                    <span class="active-facets__button-inner button button--tertiary">
                      {%- if filter.min_value.value -%}{{ filter.min_value.value | money }}{%- else -%}{{ 0 | money }}{%- endif -%}-{%- if filter.max_value.value -%}{{ filter.max_value.value | money }}{%- else -%}{{ filter.range_max | money }}{%- endif -%}
                      {% render 'icon-close-small' %}
                      <span class="visually-hidden">{{ 'products.facets.clear_filter' | t }}</span>
                    </span>
                  </a>
                </facet-remove>
              {%- endif -%}
            {%- endif -%}
          {%- endfor -%}
          <facet-remove class="active-facets__button-wrapper">
            <a href="{{ results_url }}" class="active-facets__button-remove underlined-link">
              <span>{{ 'products.facets.clear_all' | t }}</span>
            </a>
          </facet-remove>
        </div>
        <div class="product-count light{% unless collapse_on_larger_devices %}hidden  {% endunless %} hidden "   role="status">
          <p id="ProductCount" class="product-count__text">
            {%- if results.results_count -%}
              {{ 'templates.search.results_with_count' | t: terms: results.terms, count: results.results_count }}
            {%- elsif results.products_count == results.all_products_count -%}
              {{ 'products.facets.product_count_simple' | t: count: results.products_count }}
            {%- else -%}
              {{ 'products.facets.product_count' | t: product_count: results.products_count, count: results.all_products_count }}
            {%- endif -%}
          </p>
          <div class="loading-overlay__spinner">
            <svg aria-hidden="true" focusable="false" role="presentation" class="spinner" viewBox="0 0 66 66" xmlns="http://www.w3.org/2000/svg">
              <circle class="path" fill="none" stroke-width="6" cx="33" cy="33" r="30"></circle>
            </svg>
          </div>
        </div>
    </div>
  </div>